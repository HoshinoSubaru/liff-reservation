<script>
// LINE SDK
// URLパラメータから page の値を取得し、日時選択画面でのみログインを求める
// ログイン済ならログインを求めない
const urlParams = new URLSearchParams(window.location.search);
const pageParam = urlParams.get('page');

liff.init({ liffId: 'YOUR_LIFF_ID' })
  .then(() => {
    if (pageParam !== 'reserve_personal' && !liff.isLoggedIn()) {
      liff.login();
    } else if (liff.isLoggedIn()) {
      liff.getProfile()
        .then(profile => {
          console.log('LINE名:', profile.displayName);
        })
        .catch(err => {
          console.error('プロフィール取得に失敗しました:', err);
        });
    }
  })
  .catch(err => {
    console.error('LIFFの初期化に失敗しました:', err);
  });

  // 日付と時間を保管するための変数
  let selectedDate = "";
  let selectedTime = "";
  let eventsData = []; // サーバーから取得したイベントを格納する

  // ページ読み込み完了時に実行する処理をまとめる
  document.addEventListener("DOMContentLoaded", () => {
    // 1. サーバーからイベントを取得し、カレンダーをセットアップ
    google.script.run.withSuccessHandler(setupCalendar).getEvents();

    // 2. 時間ボタンの生成
    generateTimeSlots();

    // 3. 「次へ進む」ボタンのクリックイベント登録
    const nextButton = document.getElementById("next-button");
    nextButton.addEventListener("click", submitReservation);
  });

  // カレンダーを初期化する関数
  function setupCalendar(events) {
    // 取得したイベントをグローバルに保存
    eventsData = events;

    // イベントの start から日付部分(Y-m-d)を取り出し、選択可能な日付一覧を作る
    const availableDates = events.map(event => event.start.split("T")[0]);

    document.addEventListener("DOMContentLoaded", () => {

  // #flatpickr という要素があればカレンダー関連の処理をする
      if (document.getElementById("flatpickr")) {
        google.script.run.withSuccessHandler(setupCalendar).getEvents();
        generateTimeSlots();
        const nextButton = document.getElementById("next-button");
        if (nextButton) {
          nextButton.addEventListener("click", submitReservation);
        }
      }
    });
  }

  // 時間ボタンを生成する関数
  function generateTimeSlots() {
    const container = document.getElementById("time-buttons");
    // 既存のボタンがあれば一度クリア
    container.innerHTML = "";

    for (let hour = 11; hour <= 18; hour++) {
      for (let minutes = 0; minutes < 60; minutes += 30) {
        if (hour === 18 && minutes > 30) break;

        const time = `${hour.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`;

        // ボタン要素を作成
        const btn = document.createElement("button");
        btn.textContent = time;
        btn.classList.add("time-button");

        // ボタンをクリックしたら時刻を選択
        btn.onclick = () => {
          // 無効状態のボタンなら処理しない
          if (btn.disabled) return;
          selectedTime = time; // "HH:MM"
          updateSelectedDateTime();
        };

        container.appendChild(btn);
      }
    }
  }

  // 日付と時間をまとめてテキストエリアに表示
  function updateSelectedDateTime() {
    document.getElementById("selected-time").value = selectedDate + " " + selectedTime;
    // selectedDate を sessionStorage に保存
    sessionStorage.setItem("selectedDate", selectedDate);

    console.log("selectedDate:", selectedDate);
    console.log("selectedTime:", selectedTime);
    console.log("Combined:", selectedDate + " " + selectedTime);

  }

  // 各時間ボタンの利用可能／不可を更新する関数
  function updateTimeButtonsAvailability() {
    // 日付が選択されていない場合は処理しない
    if (!selectedDate) return;

    // 選択された日付のイベントのみ抽出
    const eventsOnSelectedDate = eventsData.filter(event => {
      return event.start.split("T")[0] === selectedDate;
    });

    // 30分枠ごとに、イベントと重なっているかチェック
    const buttons = document.querySelectorAll(".time-button");
    buttons.forEach(btn => {
      btn.disabled = false; // 初期化
      btn.classList.remove("disabled");

      // ボタンの時刻から日時オブジェクトを作成
      const slotStart = new Date(selectedDate + "T" + btn.textContent + ":00");
      const slotEnd = new Date(slotStart.getTime() + 30 * 60 * 1000); // 30分後

      // イベントとスロットが重複していればボタンを無効化
      for (let event of eventsOnSelectedDate) {
        const eventStart = new Date(event.start);
        const eventEnd = new Date(event.end);
        // イベントとスロットの重複判定
        if (eventEnd > slotStart && eventStart < slotEnd) {
          btn.disabled = true;
          btn.classList.add("disabled");
          break;
        }
      }
    });
  }

/**
   * 「次へ進む」ボタン押下時の処理（個人情報入力ページへ遷移）
   */
   function submitReservation() {
    console.log("submitReservation called");
    //alert("submitReservation called");

    const selectedText = document.getElementById("selected-time").value;
    console.log("selectedText =", selectedText);
  
    if (!selectedText.trim()) {
      alert("日時を選択してください");
      console.log("No selected date/time. Aborting.");
      return;
    }
  
    sessionStorage.setItem("selectedTime", selectedText);
    console.log("sessionStorage.setItem done. selectedTime =", selectedText);
  
    // テンプレート変数を埋め込み（Apps Script テンプレートとして処理される場合）
    // Githubのコードチェックで「Expression expected.」エラーが出ているが、GAS固有のテンプレート記法のため無視して良い
    let baseUrl = <?= redirectUrl ?>;
    //alert(baseUrl)
    //baseUrl = "https://script.google.com/a/macros/urlounge.co.jp/s/AKfycbw4PDHBrkhlXDZvIfTfjMy-TIz4phoT0IBOanB4IBdsFF8G6B2V89AHb14gBkyflTIq-A/exec"
    const nextUrl = baseUrl + "?page=reserve_personal";

    // デバッグ用
    // alert("redirecting to: " + nextUrl);
  
    location.href = nextUrl;
  }

  // 個人情報入力ページのフォーム送信処理
  function submitPersonalInfo() {

    // sessionStorage から日時を取得
    let storedTime = sessionStorage.getItem("selectedTime");

    // もし日時が空または null なら、テスト用の日時を補完する
    if (!storedTime || !storedTime.trim()) {
      storedTime = "2025-03-25 17:00";  // テスト用デフォルト日時
    }

    const personalData = {

      // テスト用コード
      time: storedTime,  
      date: "",          

      /*　テストが終わったら、これに差し替えること
      time: sessionStorage.getItem("selectedTime"),
      date: sessionStorage.getItem("selectedDate"),
      */

      purpose: document.getElementById("purpose").value,
      firstName: document.getElementById("first-name").value,
      lastName: document.getElementById("last-name").value,
      firstNameKana: document.getElementById("first-name-kana").value,
      lastNameKana: document.getElementById("last-name-kana").value,
      staff: document.getElementById("staff").value,
      usage: document.getElementById("usage").value
    };

    console.log("submitPersonalInfo called", personalData);

    let missingFields = [];
    for (let key in personalData) {
      // time と date は必須ではない
      if ((key !== 'time' && key !== 'date') && !personalData[key]) {
        missingFields.push(key);
      }
    }

    if (missingFields.length > 0) {
      alert("以下の項目が未入力です: " + missingFields.join(", "));
      return;
    }

    console.log("Sending data to server...");
    
    google.script.run
  .withSuccessHandler(function(eventId) {
    alert("予約が完了しました！\nイベントID: " + eventId);
  })
  .withFailureHandler(function(err) {
    alert("エラーが発生しました: " + err.message);
  })
  .submitReservationToSheet(personalData);

  }
</script>
